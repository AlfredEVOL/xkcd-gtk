---

language: go

stages:
  - build
  - check
  - test
  - package

jobs:
  allow_failures:
    - language: node_js
    - stage: check

  include:
    - &build
      stage: build
      dist: bionic
      language: go
      go: "1.10.x"
      addons:
        apt:
          packages:
            - appstream-util
            - golint
            - libgtk-3-dev
            - libxml2-utils
            - yamllint
      cache:
        directories:
          - $HOME/.cache/go-build
      install:
        - make deps BUILDFLAGS="-v -d"
      script:
        - make BUILDFLAGS=-v
    - <<: *build
      go: "1.11.x"
    - <<: *build
      go: "1.x"

    - &check
      <<: *build
      stage: check
      go: "1.10.x"
      script:
        - make check
    - <<: *check
      go: "1.11.x"
    - <<: *check
      go: "1.x"

    - &test
      <<: *build
      stage: test
      go: "1.10.x"
      script:
        - make test
    - <<: *test
      go: "1.11.x"
    - <<: *test
      go: "1.x"

    - stage: package
      name: Houston CI
      dist: bionic
      language: node_js
      node_js: 10/*
      services:
        - docker
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - libstdc++-5-dev
      install:
        - npm i -g @elementaryos/houston
      script:
        - houston ci
